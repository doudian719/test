<!DOCTYPE HTML>
<html>
<head>
   <meta charset="utf-8"/>
   <meta name="viewport" content="width=device-width,user-scalable=no"/>
   <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/>
   <link rel="icon" type="image/png" th:href="@{/icons/favicon.png}"/>
  <title>Task Scheduler Manager</title>
  <!-- Tell the browser to be responsive to screen width -->
  <link th:href="@{/flat_ui/css/vendor/bootstrap.min.css}" rel="stylesheet"/>
  <link th:href="@{/flat_ui/css/flat-ui.css}" rel="stylesheet"/>
  <!-- Bootstrap 3.3.7 -->
  <link th:href="@{/bootstrap/css/bootstrap.min.css}"  rel="stylesheet">
  <!-- Font Awesome -->
  <link th:href="@{/font-awesome/css/font-awesome.min.css}"  rel="stylesheet">
  <!-- Ionicons -->
  <link th:href="@{/Ionicons/css/ionicons.min.css}"  rel="stylesheet">
  <!-- Theme style -->
  <link th:href="@{/AdminLTE/css/AdminLTE.min.css}"  rel="stylesheet">
  <!-- AdminLTE Skins. Choose a skin from the css/skins
       folder instead of downloading all of them to reduce the load. -->
  <link th:href="@{/AdminLTE/css/skins/_all-skins.min.css}"  rel="stylesheet">

  <!-- Google Font -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,600,700,300italic,400italic,600italic">

  <style>
    .treeview-menu li a {
      color: gray;
    }
    .treeview-menu li a i {
      color: inherit;
    }
    .treeview-menu li.active > a {
      color: #3CBCBCFF !important;
    }
    .treeview-menu li.active > a i {
      color: inherit;
    }
    
    /* 确保主体内容能填充整个可见区域 */
    html, body {
      height: 100%;
    }
    .wrapper {
      min-height: 100%;
    }
    .content-wrapper {
      min-height: calc(100vh - 101px); /* 减去header(50px)和footer(51px)的高度 */
    }
    /* 确保iframe有适当的边距 */
    #main {
      margin-bottom: 15px;
      overflow: auto !important; /* 确保滚动条正常工作 */
    }
    
    /* 确保内嵌页面中的表格正确显示 */
    .content table {
      table-layout: auto;
      width: auto;
      max-width: 100%;
    }
    .content table th, 
    .content table td {
      padding: 8px;
      word-break: normal;
      overflow: visible;
    }
  </style>

</head>

<body class="hold-transition skin-blue sidebar-mini">
<div class="wrapper">
  <header class="main-header">
    <!-- Logo -->
    <a href="main.html" class="logo">
      <span class="logo-mini"><b>T</b>ask</span>
      <span class="logo-lg">Task Manager</span>
    </a>
    <nav class="navbar navbar-static-top">
      <a href="#" class="sidebar-toggle" data-toggle="push-menu" role="button">
        <span class="sr-only">Toggle navigation</span>
      </a>
      <div class="navbar-custom-menu">
        <ul class="nav navbar-nav">
          <!-- 消息提醒  -->
          <li class="dropdown notifications-menu">
            <a href="#" class="dropdown-toggle" data-toggle="dropdown">
              <i class="fa fa-bell-o"></i>
              <span class="label label-warning">1</span>
            </a>
            <ul class="dropdown-menu">
              <li class="header">You have 1 notification</li>
              <li>
                <!-- inner menu: contains the actual data -->
                <ul class="menu">
                  <li>
                    <a href="#">
                      <i class="fa fa-users text-aqua"></i> One task execution failed
                    </a>
                  </li>
                </ul>
              </li>
              <li class="footer"><a href="javaScript:void(0)">View all</a></li>
            </ul>
          </li>
          <!-- 任务提醒 -->
          <li class="dropdown user user-menu">
            <a href="#" class="dropdown-toggle" data-toggle="dropdown">
              <img th:src="@{/AdminLTE/img/user2-160x160.jpg}"  class="user-image" alt="User Image">
              <span class="hidden-xs">Admin</span>
            </a>
            <ul class="dropdown-menu">
              <li class="user-header">
                <img th:src="@{/AdminLTE/img/user2-160x160.jpg}"  class="img-circle" alt="User Image">
                <p>Task Scheduler Manager</p>
              </li>
              <li class="user-body">
                <div class="row">
                  <div class="col-xs-4 text-center">
                    <a href="#">Followers</a>
                  </div>
                  <div class="col-xs-4 text-center">
                    <a href="#">Sales</a>
                  </div>
                  <div class="col-xs-4 text-center">
                    <a href="#">Friends</a>
                  </div>
                </div>
                <!-- /.row -->
              </li>
              <!-- Menu Footer-->
              <li class="user-footer">
                <div class="pull-left">
                  <a href="#" class="btn btn-default btn-flat">Profile</a>
                </div>
                <div class="pull-right">
                  <a href="login.html" class="btn btn-default btn-flat">Sign out</a>
                </div>
              </li>
            </ul>
          </li>
          <li>
            <a href="#" data-toggle="control-sidebar"><i class="fa fa-gears"></i></a>
          </li>
        </ul>
      </div>
    </nav>
  </header>
  <aside class="main-sidebar">
    <section class="sidebar">
      <div class="user-panel">
        <div class="pull-left image">
          <img th:src="@{/AdminLTE/img/user2-160x160.jpg}"  class="img-circle" alt="User Image">
        </div>
        <div class="pull-left info">
          <p>Admin</p>
          <a href="#"><i class="fa fa-circle text-success"></i> Online</a>
        </div>
      </div>

      <ul class="sidebar-menu" data-widget="tree">
        <li class="active treeview menu-open">
          <a href="#">
            <i class="fa fa-dashboard"></i> <span>Task Management</span>
            <span class="pull-right-container">
                <i class="fa fa-angle-left pull-right"></i>
            </span>
          </a>
          <ul class="treeview-menu">
            <li data-src="task/index.html"><a  href="#task/index.html"><i class="fa fa-circle-o"></i>Task List</a></li>
            <li data-src="task/log.html" ><a  href="#task/log.html"><i class="fa fa-circle-o"></i>Task Logs</a></li>
            <li data-src="task/cron.html" style="visibility: hidden"><a  href="#task/cron.html"><i class="fa fa-circle-o"></i>Expression Generator</a></li>
          </ul>
        </li>
      </ul>

      <ul class="sidebar-menu" data-widget="tree">
        <li class="active treeview menu-open">
          <a href="#">
            <i class="fa fa-suitcase"></i> <span>Tools</span>
            <span class="pull-right-container">
                <i class="fa fa-angle-left pull-right"></i>
            </span>
          </a>
          <ul class="treeview-menu">
            <li data-src="util/yaml-validator.html"><a  href="#util/yaml-validator.html"><i class="fa fa-circle-o"></i>YAML</a></li>
            <li data-src="util/base64-tool.html"><a href="#util/base64-tool.html"><i class="fa fa-circle-o"></i>Base64</a></li>
            <li data-src="util/json-tool.html"><a href="#util/json-tool.html"><i class="fa fa-circle-o"></i>JSON</a></li>
          </ul>
        </li>
      </ul>

      <ul class="sidebar-menu" data-widget="tree">
        <li class="active treeview menu-open">
          <a href="#">
            <i class="fa fa-cloud"></i> <span>Kubernetes</span>
            <span class="pull-right-container">
              <i class="fa fa-angle-left pull-right"></i>
            </span>
          </a>
          <ul class="treeview-menu">
            <li data-src="kubernetes/namespaces.html"><a href="#kubernetes/namespaces.html"><i class="fa fa-circle-o"></i>Namespace</a></li>
            <li data-src="kubernetes/pods.html"><a href="#kubernetes/pods.html"><i class="fa fa-circle-o"></i>Pod</a></li>
            <li data-src="kubernetes/log.html"><a href="#kubernetes/log.html"><i class="fa fa-circle-o"></i>Log</a></li>
            <li data-src="kubernetes/crd.html"><a href="#kubernetes/crd.html"><i class="fa fa-circle-o"></i>CRD</a></li>
            <li data-src="kubernetes/crd-instances.html"><a href="#kubernetes/crd-instances.html"><i class="fa fa-circle-o"></i>CRD Instance</a></li>
            <li data-src="kubernetes/ksvc.html"><a href="#kubernetes/ksvc.html"><i class="fa fa-circle-o"></i>KSVC</a></li>
            <li data-src="kubernetes/deployments.html"><a href="#kubernetes/deployments.html"><i class="fa fa-circle-o"></i>Deployment</a></li>
            <li data-src="kubernetes/configmaps.html"><a href="#kubernetes/configmaps.html"><i class="fa fa-circle-o"></i>ConfigMap</a></li>
            <li data-src="kubernetes/secrets.html"><a href="#kubernetes/secrets.html"><i class="fa fa-circle-o"></i>Secret</a></li>
            <li data-src="kubernetes/events.html"><a href="#kubernetes/events.html"><i class="fa fa-circle-o"></i>Event</a></li>
            <li data-src="kubernetes/diagnosis.html"><a href="#kubernetes/diagnosis.html"><i class="fa fa-stethoscope"></i>Diagnosis</a></li>
            <li data-src="kubernetes/command.html"><a href="#kubernetes/command.html"><i class="fa fa-terminal"></i>Command</a></li>
          </ul>
        </li>
        
        <li class="treeview active menu-open">
          <a href="#">
            <i class="fa fa-database"></i> <span>Others</span>
            <span class="pull-right-container">
              <i class="fa fa-angle-left pull-right"></i>
            </span>
          </a>
          <ul class="treeview-menu">
            <li data-src="azure/azure-repo.html"><a href="#hasura/azure-repo.html"><i class="fa fa-circle-o"></i>Azure Repo</a></li>
            <li data-src="hasura/hasura.html"><a href="#hasura/hasura.html"><i class="fa fa-circle-o"></i>Hasura</a></li>
          </ul>
        </li>
        
        <li class="treeview active menu-open">
          <a href="#">
            <i class="fa fa-cogs"></i> <span>System Config</span>
            <span class="pull-right-container">
              <i class="fa fa-angle-left pull-right"></i>
            </span>
          </a>
          <ul class="treeview-menu">
            <li data-src="system/env.html"><a href="#system/env.html"><i class="fa fa-circle-o"></i>K8S env</a></li>
          </ul>
        </li>
      </ul>

    </section>
  </aside>

  <div class="content-wrapper">
    <section class="content-header">
      <h1>
        Dashboard
      </h1>
      <ol class="breadcrumb">
        <li><a href="main.html"><i class="fa fa-dashboard"></i> Home</a></li>
        <li class="active">Dashboard</li>
      </ol>
    </section>
    <!-- 主页 -->
    <section class="content">
      <div class="row">
        <div class="col-md-3 col-sm-6 col-xs-12">
          <div class="info-box">
            <span class="info-box-icon bg-aqua"><i class="fa fa-tasks"></i></span>

            <div class="info-box-content">
              <span class="info-box-text">Total Tasks</span>
              <span class="info-box-number" th:text="${totalJobCount}"></span>
            </div>
          </div>
        </div>
        <div class="col-md-3 col-sm-6 col-xs-12">
          <div class="info-box">
            <span class="info-box-icon bg-red"><i class="fa fa-times-circle"></i></span>

            <div class="info-box-content">
              <span class="info-box-text">Failed Tasks</span>
              <span class="info-box-number" th:text="${failureLogCount}"></span>
            </div>
          </div>
        </div>
        <div class="clearfix visible-sm-block"></div>
        <div class="col-md-3 col-sm-6 col-xs-12">
          <div class="info-box">
            <span class="info-box-icon bg-green"><i class="fa fa-check-circle"></i></span>

            <div class="info-box-content">
              <span class="info-box-text">Successful Tasks</span>
              <span class="info-box-number" th:text="${successLogCount}"></span>
            </div>
          </div>
        </div>
        <div class="col-md-3 col-sm-6 col-xs-12">
          <div class="info-box">
            <span class="info-box-icon bg-yellow"><i class="fa fa-play-circle"></i></span>

            <div class="info-box-content">
              <span class="info-box-text">Running Tasks</span>
              <span class="info-box-number" th:text="${runningLogCount}"></span>
            </div>
          </div>
        </div>
      </div>
      <div class="row">
        <div class="col-md-12">
          <div class="box box-primary">
            <div class="box-header with-border">
              <h3 class="box-title">Content Area</h3>
            </div>
            <div class="box-body">
              <iframe scrolling="auto" frameborder="0"
                style="width: 100%; min-height: 600px; max-height: 80vh; overflow: auto; background: #fff;"
                src='' id="main" name="main"></iframe>
            </div>
          </div>
        </div>
      </div>
    </section>
  </div>

  <footer class="main-footer">
    <strong>Copyright &copy; 2022-2023 <a href="https://www.sc.com">Task Scheduler Manager</a>.</strong> All rights
    reserved.
  </footer>
  <!-- Control Sidebar -->
  <aside class="control-sidebar control-sidebar-dark">
    <div class="tab-content">
      <div class="tab-pane" id="control-sidebar-home-tab">
        
      </div>

    </div>
  </aside>
  <div class="control-sidebar-bg"></div>
</div>
<!-- jQuery 3 -->
<script th:src="@{/libs/jquery-3.2.1.min.js}"></script>
<script th:src="@{/layer/layer.js}" type="text/javascript"></script>
<!-- Bootstrap 3.3.7 -->
<script th:src="@{/bootstrap/js/bootstrap.min.js}"></script>
<!-- AdminLTE App -->
<script th:src="@{/AdminLTE/js/adminlte.min.js}"></script>
<!-- AdminLTE for demo purposes -->
<script th:src="@{/AdminLTE/js/main.js}"></script>

<!-- VUE -->
<script th:src="@{/libs/vue.min.js}" type="text/javascript"></script>

<script>
  $(document).ready(function () {
    // 确保所有菜单都展开
    $('.treeview').addClass('active menu-open');
    
    $('.treeview-menu li a').click(function (e) {
      e.preventDefault();
      $('.treeview-menu li').removeClass('active');
      $(this).parent().addClass('active');
      $('#main').attr('src', $(this).attr('href').substring(1));
    });

    // 默认选择第一个菜单项
    $('.treeview-menu li:first a').click();

    // iframe高度调整
    function setIframeHeight() {
      var viewportHeight = $(window).height();
      var headerHeight = $('header.main-header').outerHeight() || 50;
      var footerHeight = $('footer.main-footer').outerHeight() || 50;
      var contentHeaderHeight = $('.content-header').outerHeight() || 50;
      var statsHeight = $('.row:first', '.content').outerHeight() || 130;
      var boxHeaderHeight = $('.box-header').outerHeight() || 40;
      var totalOffset = headerHeight + footerHeight + contentHeaderHeight + statsHeight + boxHeaderHeight + 60; // 添加额外的padding/margin
      
      var newHeight = Math.max(500, viewportHeight - totalOffset);
      $('#main').css('height', newHeight + 'px');
      
      // 记录高度，用于诊断问题
      console.log('Window height: ' + viewportHeight);
      console.log('Calculated iframe height: ' + newHeight);
    }

    // 初始调整
    setIframeHeight();
    
    // 窗口大小改变时调整
    $(window).resize(function() {
      setIframeHeight();
    });

    // iframe加载后可能需要重新调整
    $('#main').on('load', function() {
      setIframeHeight();
      
      // 尝试修复iframe内部的表格布局
      try {
        var iframeDoc = this.contentDocument || this.contentWindow.document;
        var tableStyle = document.createElement('style');
        tableStyle.textContent = `
          table { table-layout: auto; width: auto; max-width: 100%; }
          table th, table td { word-break: normal; overflow: visible; }
        `;
        iframeDoc.head.appendChild(tableStyle);
      } catch (e) {
        console.warn('Cannot access iframe content: ' + e);
      }
    });
  });
</script>

<script type="text/javascript">
  var vm = new Vue({
    el : '#app',
    data : {
      socket: null
    },
    methods : {
      initWebSocket : function () {
        this.socket = new WebSocket('ws://localhost:8080/websocket');
        this.socket.addEventListener('message', (event) => {
          console.log(event.data);
          this.handleMessage(event.data);
        });
      },
      handleMessage : function(msg) {
        // alert(msg);
        // 解析消息，假设 msg 是一个 JSON 字符串，包含类型（info、warning、error）和内容
        const messageData = JSON.parse(msg);
        const messageType = messageData.type;
        const jobInfo = messageData.jobInfo;
        const messageContent = messageData.content;

        let iconPath = '/icons/circle-info.png'; // 默认为信息类型图标

        if (messageType === 'warning') {
          iconPath = '/icons/exclamation-triangle.png';
        } else if (messageType === 'error') {
          iconPath = '/icons/times-circle.png';
        }

        // 请求通知权限
        Notification.requestPermission().then(function(permission) {
          if (permission === 'granted') {
            // 显示桌面通知
            const notification = new Notification(jobInfo, {
              body: messageContent,
              icon: iconPath, // 设置通知的图标
              requireInteraction: true, // 通知在用户操作之前一直保持可见
            });

            // 点击通知后关闭
            notification.onclick = function() {
              notification.close();
            };
          } else {
            console.log("No permission to pop up notification ...");
          }
        });
      }
    },
    mounted: function() {
      this.initWebSocket();
    },
    beforeDestroy() {
      this.socket.disconnect();
    }
  })

</script>
</body>
</html>
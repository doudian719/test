<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>CRD Instance Management</title>
    <meta name="author" content="TSM" />
    <link rel="stylesheet" th:href="@{/iview/iview.css}">
    <script th:src="@{/libs/jquery-3.2.1.min.js}" type="text/javascript"></script>
    <script th:src="@{/libs/vue.min.js}" type="text/javascript"></script>
    <script th:src="@{/layer/layer.js}" type="text/javascript"></script>
    <script th:src="@{/iview/iview.min.js}" type="text/javascript"></script>
    <script th:src="@{/common.js}" type="text/javascript"></script>
    <style type="text/css">
        [v-cloak] { display: none; }
        .json-viewer {
            font-family: monospace;
            white-space: pre-wrap;
            word-wrap: break-word;
            background-color: #f5f5f5;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
        }
        .action-buttons { display: flex; gap: 8px; }
    </style>
</head>
<body>
<div id="app" v-cloak>
    <div style="margin-bottom: 6px;margin: 30px">
        <i-select v-model="envSearch" @on-change="fetchCRDTypes()" placeHolder="Environment" style="width: 180px">
            <i-option v-for="item in envOptions" :value="item.value" :key="item.value">{{ item.label }}</i-option>
        </i-select>
        <i-select v-model="crdTypeSearch" @on-change="onCRDTypeChange" placeHolder="CRD Type" filterable style="width: 260px">
            <i-option v-for="item in crdTypeOptions" :value="item.value" :key="item.value">{{ item.label }}</i-option>
        </i-select>
        <i-select v-model="namespaceSearch" :disabled="crdTypeScope !== 'Namespaced'" @on-change="search()" placeHolder="Namespace" filterable style="width: 180px">
            <i-option v-for="item in namespaceOptions" :value="item.value" :key="item.value">{{ item.label }}</i-option>
        </i-select>
        <i-input v-model="instanceNameSearch" @on-enter="search()" placeHolder="Instance Name" style="width: 180px"></i-input>
        <i-button type="primary" @click="search()" icon="ios-search">Search</i-button>
        <i-button type="primary" @click="empty()" icon="ios-close-empty">Clear</i-button>
        <i-button type="success" @click="createInstance()" icon="md-add">Create Instance</i-button>
    </div>
    <div style="margin-bottom: 6px;margin: 30px">
        <template>
            <i-table border :columns="tableTitle" :data="PageData"></i-table>
            <Page :total="total" :current="currentPage" :page-size="pageSize" show-total show-elevator show-sizer @on-change="handlePageChange" @on-page-size-change="handlePageSizeChange" style="margin-top: 16px; text-align: right;"/>
        </template>
    </div>
    <!-- Instance Details Modal -->
    <Modal v-model="showInstanceDetails" title="CRD Instance Details" width="800">
        <div class="json-viewer" v-html="formatJSON(currentInstance)"></div>
        <div slot="footer">
            <Button type="primary" @click="showInstanceDetails = false">Close</Button>
        </div>
    </Modal>
    <!-- Create/Edit Instance Modal -->
    <Modal v-model="showInstanceForm" :title="isEditInstance ? 'Edit CRD Instance' : 'Create CRD Instance'" width="1000">
        <Form :model="instanceForm" :label-width="120">
            <FormItem label="Instance Name">
                <Input v-model="instanceForm.name" placeholder="Enter instance name"></Input>
            </FormItem>
            <FormItem label="Instance Definition">
                <textarea v-model="instanceForm.definition"
                    rows="18"
                    style="width:100%;min-width:100%;font-family:monospace;resize:vertical;line-height:1.5;white-space:pre;overflow:auto;"
                    placeholder="Enter instance definition in JSON format"></textarea>
                <Button type="dashed" native-type="button" size="small" style="margin-top:8px;float:right;" @click.prevent="formatInstanceJson">Format JSON</Button>
            </FormItem>
        </Form>
        <div slot="footer">
            <Button type="primary" @click="saveInstance">Save</Button>
            <Button @click="showInstanceForm = false">Cancel</Button>
        </div>
    </Modal>
</div>
<script type="text/javascript">
    var vm = new Vue({
        el : '#app',
        data : {
            envSearch : '',
            crdTypeSearch: '',
            crdTypeScope: '',
            namespaceSearch: '',
            instanceNameSearch: '',
            envOptions: [],
            crdTypeOptions: [],
            namespaceOptions: [],
            PageData : [],
            total: 0,
            currentPage: 1,
            pageSize: 10,
            showInstanceDetails: false,
            showInstanceForm: false,
            isEditInstance: false,
            currentInstance: null,
            instanceForm: {
                name: '',
                definition: ''
            },
            tableTitle: [{
                title: 'No.',
                type: 'index',
                width: 70,
                align: 'center'
            }, {
                title: 'Name',
                key: 'name',
                width: 220
            }, {
                title: 'Namespace',
                key: 'namespace',
                width: 120
            }, {
                title: 'Created At',
                key: 'createdAt',
                width: 180
            }, {
                title: 'Labels',
                key: 'labels',
                width: 220
            }, {
                title: 'Annotations',
                key: 'annotations',
                width: 400,
                render: (h, params) => {
                    return h('div', {
                        domProps: { innerHTML: params.row.annotations }
                    });
                }
            }, {
                title: 'Status',
                key: 'status',
                width: 400,
                render: (h, params) => {
                    return h('div', {
                        domProps: { innerHTML: params.row.status }
                    });
                }
            }, {
                title: 'OwnerReferences',
                key: 'ownerReferences',
                width: 220
            }, {
                title: 'Action',
                key: 'action',
                width: 300,
                render: (h, params) => {
                    return h('div', { class: 'action-buttons' }, [
                        h('Button', {
                            props: { type: 'primary', size: 'small', icon: 'ios-eye' },
                            on: { click: () => { vm.viewInstanceDetails(params.row); } }
                        }, 'View'),
                        h('Button', {
                            props: { type: 'success', size: 'small', icon: 'ios-create' },
                            on: { click: () => { vm.editInstance(params.row); } }
                        }, 'Edit'),
                        h('Button', {
                            props: { type: 'error', size: 'small', icon: 'ios-trash' },
                            on: { click: () => { vm.deleteInstance(params.row); } }
                        }, 'Delete')
                    ]);
                }
            }]
        },
        mounted: function() {
            this.loadEnvOptions();
        },
        methods: {
            loadEnvOptions: function() {
                this.envSearch = '';
                this.crdTypeSearch = '';
                this.namespaceSearch = '';
                $.ajax({
                    url: "/system/env/visible?resourceType=K8S",
                    type: "GET",
                    success: (result) => {
                        if (result.success) {
                            this.envOptions = result.data.map(env => ({ value: env.name, label: env.name }));
                        }
                    }
                });
            },
            fetchCRDTypes: function() {
                this.crdTypeSearch = '';
                this.crdTypeScope = '';
                this.crdTypeOptions = [];
                this.namespaceSearch = '';
                this.namespaceOptions = [];
                if (!this.envSearch) return;
                $.ajax({
                    url: "../kubernetes/crd/namespaced-list",
                    type: "get",
                    data: { env: this.envSearch },
                    success: (result) => {
                        this.crdTypeOptions = result.map(item => ({ value: item.metadata.name, label: item.metadata.name, scope: item.spec.scope }));
                    }
                });
            },
            onCRDTypeChange: function(val) {
                const selected = this.crdTypeOptions.find(opt => opt.value === val);
                this.crdTypeScope = selected ? selected.scope : '';
                if (this.crdTypeScope === 'Namespaced') {
                    this.fetchNamespace();
                } else {
                    this.namespaceSearch = '';
                    this.namespaceOptions = [];
                }
            },
            fetchNamespace: function() {
                this.namespaceSearch = '';
                this.namespaceOptions = [];
                if (!this.envSearch) return;
                $.ajax({
                    url:"../kubernetes/namespaces",
                    type:"post",
                    data:{'env':this.envSearch},
                    success: function(result) {
                        vm.namespaceOptions = result.msg.pageData.map(function(item) {
                            return {
                                value: item.name,
                                label: item.name
                            };
                        });
                    }
                });
            },
            search: function(showNotice = true) {
                if(!this.envSearch || !this.crdTypeSearch) return;
                $.ajax({
                    url: "../kubernetes/crd/instances",
                    type: "get",
                    data: {
                        env: this.envSearch,
                        crdName: this.crdTypeSearch,
                        namespace: this.crdTypeScope === 'Namespaced' ? this.namespaceSearch : '',
                        keyword: this.instanceNameSearch,
                        page: this.currentPage,
                        pageSize: this.pageSize
                    },
                    success: (result) => {
                        if(result && result.msg && Array.isArray(result.msg.pageData)) {
                            this.PageData = result.msg.pageData.map(item => {
                                return {
                                    name: item.metadata.name,
                                    namespace: item.metadata.namespace || '-',
                                    createdAt: item.metadata.creationTimestamp,
                                    labels: item.metadata.labels
                                        ? Object.entries(item.metadata.labels).map(([k, v]) => `${k}=${v}`).join('; ')
                                        : '',
                                    annotations: item.metadata.annotations
                                        ? Object.entries(item.metadata.annotations).map(([k, v]) => `${k}=${v}`).join('<br>')
                                        : '',
                                    status: item.status
                                        ? Object.entries(item.status).map(([k, v]) => `${k}: ${typeof v === 'object' ? (Array.isArray(v) ? '[Array]' : '[Object]') : v}`).join('<br>')
                                        : '',
                                    ownerReferences: item.metadata.ownerReferences && item.metadata.ownerReferences.length > 0
                                        ? item.metadata.ownerReferences.map(ref => ref.kind + '/' + ref.name).join('; ')
                                        : '',
                                    raw: item
                                };
                            });
                            this.total = result.msg.totalCount;
                        } else {
                            this.PageData = [];
                            this.total = 0;
                        }
                        if (showNotice) {
                            this.$Notice.success({ desc: 'Data loaded successfully' });
                        }
                    },
                    error: () => {
                        if (showNotice) {
                            this.$Notice.error({ desc: 'Failed to load data, please try again later' });
                        }
                    }
                });
            },
            empty: function() {
                this.crdTypeSearch = '';
                this.namespaceSearch = '';
                this.instanceNameSearch = '';
                this.PageData = [];
                this.total = 0;
            },
            handlePageChange: function(page) {
                this.currentPage = page;
                this.search(false);
            },
            handlePageSizeChange: function(size) {
                this.pageSize = size;
                this.currentPage = 1;
                this.search(false);
            },
            formatJSON: function(obj) {
                if (!obj) return '';
                return JSON.stringify(obj, null, 2)
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/"/g, '&quot;')
                    .replace(/'/g, '&#039;')
                    .replace(/\n/g, '<br>')
                    .replace(/\s/g, '&nbsp;');
            },
            viewInstanceDetails: function(row) {
                this.currentInstance = row.raw;
                this.showInstanceDetails = true;
            },
            createInstance: function() {
                this.isEditInstance = false;
                this.instanceForm = { name: '', definition: '' };
                this.showInstanceForm = true;
            },
            editInstance: function(row) {
                this.isEditInstance = true;
                this.instanceForm = {
                    name: row.name,
                    definition: JSON.stringify(row.raw, null, 2)
                };
                if (this.crdTypeScope === 'Namespaced' && row.namespace && row.namespace !== '-') {
                    this.namespaceSearch = row.namespace;
                }
                this.showInstanceForm = true;
            },
            deleteInstance: function(row) {
                this.$Modal.confirm({
                    title: 'Delete CRD Instance',
                    content: `Are you sure you want to delete instance "${row.name}"?`,
                    onOk: () => {
                        $.ajax({
                            url: `../kubernetes/crd/${this.crdTypeSearch}/instances/${row.name}`,
                            type: 'delete',
                            data: {
                                env: this.envSearch,
                                namespace: this.namespaceSearch
                            },
                            success: () => {
                                this.$Notice.success({ desc: 'CRD instance deleted successfully' });
                                this.search(false);
                            },
                            error: (xhr) => {
                                this.$Notice.error({ desc: 'Failed to delete CRD instance: ' + xhr.statusText });
                            }
                        });
                    }
                });
            },
            saveInstance: function() {
                if (this.crdTypeScope === 'Namespaced' && !this.namespaceSearch) {
                    this.$Notice.error({ desc: '请先选择命名空间！' });
                    return;
                }
                try {
                    const instance = JSON.parse(this.instanceForm.definition);
                    const url = this.isEditInstance ? 
                        `../kubernetes/crd/${this.crdTypeSearch}/instances/${this.instanceForm.name}` : 
                        `../kubernetes/crd/${this.crdTypeSearch}/instances`;
                    const data = {
                        env: this.envSearch,
                        namespace: this.crdTypeScope === 'Namespaced' ? this.namespaceSearch : '',
                        instance: instance
                    };
                    $.ajax({
                        url: url,
                        type: this.isEditInstance ? 'put' : 'post',
                        contentType: 'application/json',
                        data: JSON.stringify(data),
                        success: () => {
                            this.$Notice.success({ desc: `CRD instance ${this.isEditInstance ? 'updated' : 'created'} successfully` });
                            this.showInstanceForm = false;
                            this.search(false);
                        },
                        error: (xhr) => {
                            this.$Notice.error({ desc: `Failed to ${this.isEditInstance ? 'update' : 'create'} CRD instance: ` + xhr.statusText });
                        }
                    });
                } catch (e) {
                    this.$Notice.error({ desc: 'Invalid JSON format: ' + e.message });
                }
            },
            formatInstanceJson: function() {
                try {
                    if (this.instanceForm.definition) {
                        const obj = JSON.parse(this.instanceForm.definition);
                        this.instanceForm.definition = JSON.stringify(obj, null, 2);
                    }
                } catch (e) {
                    this.$Notice.error({ desc: 'Invalid JSON: ' + e.message });
                }
            }
        }
    });
</script>
</body>
</html> 
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Event Status</title>
    <meta name="author" content="TSM" />
    <link rel="stylesheet" th:href="@{/iview/iview.css}">
    <script th:src="@{/libs/jquery-3.2.1.min.js}"></script>
    <script th:src="@{/libs/vue.min.js}"></script>
    <script th:src="@{/layer/layer.js}"></script>
    <script th:src="@{/iview/iview.min.js}"></script>
    <script th:src="@{/common.js}"></script>
    <style>
        [v-cloak] { display: none; }
        /* 统一警告颜色与其他页面一致 */
        .warning-event td {
            background-color: #fffbe6 !important;  /* 更柔和的黄色背景 */
            color: #8a6d3b;                        /* 深黄色文字 */
        }
        .warning-event:hover td {
            background-color: #fff3d6 !important;  /* 悬停时稍深的黄色 */
        }
        
        /* 添加可调整大小的样式 */
        .resizable-modal {
            position: relative !important;
            resize: both !important;
            overflow: auto !important;
            min-width: 600px !important;
            min-height: 400px !important;
            max-width: 95vw !important;
            max-height: 95vh !important;
        }
        
        .resizable-modal .ivu-modal-content {
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        
        .resizable-modal .ivu-modal-body {
            flex: 1;
            overflow: auto;
        }
        
        /* 添加调整大小的提示 */
        .resize-handle {
            position: absolute;
            right: 0;
            bottom: 0;
            width: 20px;
            height: 20px;
            cursor: se-resize;
            background: linear-gradient(135deg, transparent 50%, #2d8cf0 50%);
            opacity: 0.5;
            transition: opacity 0.3s;
        }
        
        .resize-handle:hover {
            opacity: 1;
        }
    </style>
</head>
<body>
<div id="app" v-cloak>
    <div style="margin: 30px">
        <i-select v-model="envSearch" @on-change="fetchNamespace()" placeholder="Environment" style="width: 200px">
            <i-option v-for="item in envOptions" :value="item.value" :key="item.value">{{ item.label }}</i-option>
        </i-select>

        <i-select v-model="namespaceSearch" 
                 @on-change="search()" 
                 placeholder="Namespace" 
                 filterable
                 style="width: 200px">
            <i-option v-for="item in namespaceOptions" :value="item.value" :key="item.value">{{ item.label }}</i-option>
        </i-select>

        <i-select v-model="typeSearch" 
                 @on-change="search()" 
                 placeholder="Event Type" 
                 style="width: 200px">
            <i-option value="">All</i-option>
            <i-option value="Normal">Normal</i-option>
            <i-option value="Warning">Warning</i-option>
        </i-select>

        <i-button type="primary" @click="search()" icon="ios-search">Search</i-button>
        <i-button type="primary" @click="empty()" icon="ios-close-empty">Clear</i-button>
        <i-button type="primary" @click="search()" icon="ios-refresh">Refresh</i-button>
        <i-button type="primary" @click="monitorEvents()" icon="ios-eye">Monitor</i-button>
    </div>

    <div style="margin: 30px">
        <i-table border :columns="columns" :data="eventData" :row-class-name="rowClassName" style="width: 100%">
        </i-table>
        <br>
        <Page style="float: right;" 
              :current="pageNo" 
              :total="totalCount" 
              :page-size="pageSize"  
              @on-change="changePage" 
              @on-page-size-change="changePageSize" 
              show-elevator 
              show-sizer 
              show-total>
        </Page>
    </div>
</div>

<script>
var vm = new Vue({
    el: '#app',
    data: {
        envSearch: '',
        namespaceSearch: '',
        typeSearch: '',
        pageNo: 1,
        pageSize: 10,
        totalCount: 0,
        envOptions: [],
        namespaceOptions: [],
        eventData: [],
        columns: [
            { title: 'No.', type: 'index', width: 70, align: 'center' },
            { title: 'Environment', key: 'env', width: 120 },
            { title: 'Type', key: 'type', width: 100 },
            { title: 'Reason', key: 'reason', width: 150 },
            { title: 'Involved Object', key: 'involvedObject', width: 200 },
            { title: 'Message', key: 'message', ellipsis: true },
            { title: 'Count', key: 'count', width: 80 },
            { title: 'Last Timestamp', key: 'lastTimestamp', width: 170 }
        ]
    },
    mounted: function() {
        this.loadEnvOptions();
    },
    methods: {
        loadEnvOptions: function() {
            $.ajax({
                url: "/system/env/visible?resourceType=K8S",
                type: "GET",
                success: (result) => {
                    if (result.success) {
                        this.envOptions = result.data.map(env => {
                            return {
                                value: env.name,
                                label: env.name
                            };
                        });
                        console.log("Environment options loaded successfully:", this.envOptions);
                        
                        // Only fetch namespaces if we have a selected environment
                        if (this.envSearch) {
                            this.fetchNamespace();
                        }
                    } else {
                        this.$Notice.error({ desc: 'Failed to load environment options: ' + result.msg });
                    }
                },
                error: (xhr) => {
                    this.$Notice.error({ desc: 'Failed to request environment options: ' + xhr.statusText });
                }
            });
        },
        rowClassName(row) {
            return row.type === 'Warning' ? 'warning-event' : '';
        },
        fetchNamespace(showNotice = false) {
            $.ajax({
                url: "../kubernetes/namespaces",
                type: "post",
                data: { env: this.envSearch },
                success: (result) => {
                    this.namespaceOptions = result.msg.pageData.map(item => ({
                        value: item.name,
                        label: item.name
                    }));
                    if (showNotice) {
                        this.$Notice.success({ desc: 'Namespace loaded successfully' });
                    }
                },
                error: () => {
                    if (showNotice) {
                        this.$Notice.error({ desc: 'Failed to load namespace' });
                    }
                }
            });
        },
        search() {
            if (!this.envSearch) {
                this.$Notice.warning({ desc: 'Please select environment first' });
                return;
            }
            
            if (!this.namespaceSearch) {
                this.$Notice.warning({ desc: 'Please select namespace first' });
                return;
            }

            let params = {
                env: this.envSearch,
                namespace: this.namespaceSearch,
                type: this.typeSearch,
                pageNo: this.pageNo,
                pageSize: this.pageSize
            };

            console.log('Searching with params:', params);

            $.ajax({
                url: "../kubernetes/events",
                type: "post",
                data: params,
                success: (result) => {
                    if (result.code === 0) {
                        this.eventData = result.msg.pageData.map(item => {
                            return {
                                ...item,
                                env: this.envSearch
                            };
                        });
                        this.totalCount = result.msg.totalCount;
                        this.$Notice.success({ desc: 'Data loaded successfully' });
                        console.log('Received events:', this.eventData);
                    } else {
                        this.$Notice.error({ desc: result.msg });
                    }
                },
                error: (xhr) => {
                    this.$Notice.error({ desc: 'Request failed: ' + xhr.statusText });
                }
            });
        },
        changePage(pageNo) {
            this.pageNo = pageNo;
            this.search();
        },
        changePageSize(pageSize) {
            this.pageSize = pageSize;
            this.pageNo = 1;
            this.search();
        },
        empty() {
            this.namespaceSearch = '';
            this.typeSearch = '';
            this.pageNo = 1;
            this.search();
        },
        monitorEvents: function() {
            // Check if environment and namespace are selected
            if (!this.envSearch) {
                this.$Notice.warning({
                    desc: 'Please select environment first'
                });
                return;
            }

            let refreshTimer = null;
            let ws = null;
            const eventsList = [];
            const maxEvents = 1000; // Maximum number of events to keep in memory

            // Create WebSocket connection
            const connectWebSocket = () => {
                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const wsUrl = `${protocol}//${window.location.host}/kubernetes/events/watch?env=${this.envSearch}&namespace=${this.namespaceSearch}&type=${this.typeSearch}`;
                
                ws = new WebSocket(wsUrl);

                ws.onmessage = (event) => {
                    try {
                        const eventData = JSON.parse(event.data);
                        
                        // Filter by type if specified
                        if (this.typeSearch && eventData.type !== this.typeSearch) {
                            return;
                        }

                        // Add new event to the beginning of the list
                        eventsList.unshift(eventData);

                        // Keep only the last maxEvents events
                        if (eventsList.length > maxEvents) {
                            eventsList.pop();
                        }

                        // Update the modal content
                        const modalContent = document.querySelector('.events-monitor-content');
                        if (modalContent) {
                            modalContent.innerHTML = this.formatEventsList(eventsList);
                        }
                    } catch (error) {
                        console.error('Error processing event:', error);
                    }
                };

                ws.onclose = () => {
                    console.log('WebSocket connection closed');
                };

                ws.onerror = (error) => {
                    console.error('WebSocket error:', error);
                    this.$Notice.error({
                        desc: 'WebSocket connection error'
                    });
                };
            };

            // Format events list to HTML
            this.formatEventsList = (events) => {
                // Add HTML escape function
                const escapeHtml = (unsafe) => {
                    if (!unsafe) return '';
                    return unsafe
                        .replace(/&/g, "&amp;")
                        .replace(/</g, "&lt;")
                        .replace(/>/g, "&gt;")
                        .replace(/"/g, "&quot;")
                        .replace(/'/g, "&#039;");
                };

                return events.map(event => {
                    const typeClass = event.type === 'Warning' ? 'warning-event' : '';
                    return `
                        <div class="event-item ${typeClass}" style="margin-bottom: 10px; padding: 8px; border-bottom: 1px solid #e8e8e8;">
                            <div style="font-weight: bold; color: ${event.type === 'Warning' ? '#ff9900' : '#2d8cf0'};">
                                ${escapeHtml(event.type)} - ${escapeHtml(event.reason)}
                            </div>
                            <div style="margin-top: 4px;">
                                <span style="color: #666;">Object:</span> ${escapeHtml(event.involvedObject)}
                            </div>
                            <div style="margin-top: 4px; white-space: pre-wrap; font-family: monospace;">
                                <span style="color: #666;">Message:</span> ${escapeHtml(event.message)}
                            </div>
                            <div style="margin-top: 4px; font-size: 12px; color: #999;">
                                ${escapeHtml(event.lastTimestamp)}
                            </div>
                        </div>
                    `;
                }).join('');
            };

            // Create modal
            this.$Modal.info({
                title: 'Events Monitor',
                width: 1200,
                height: 800,
                styles: {
                    top: '50px',
                    marginBottom: '50px'
                },
                scrollable: true,
                closable: true,
                maskClosable: true,
                footer: null,
                render: (h) => {
                    return h('div', {
                        style: {
                            height: 'calc(100% - 55px)', // 减去标题栏高度
                            position: 'relative'
                        }
                    }, [
                        h('div', {
                            style: {
                                height: '100%',
                                overflow: 'auto',
                                padding: '16px'
                            },
                            class: 'events-monitor-content'
                        })
                    ]);
                },
                onRemove: () => {
                    // Close WebSocket connection when modal is closed
                    if (ws) {
                        ws.close();
                        ws = null;
                    }
                    // Remove ESC event listener
                    document.removeEventListener('keydown', handleEsc);
                }
            });

            // 在Modal渲染完成后添加可调整大小的功能
            setTimeout(() => {
                const modalWrapper = document.querySelector('.ivu-modal-wrap:not(.ivu-modal-hidden)');
                if (modalWrapper) {
                    const modalDiv = modalWrapper.querySelector('.ivu-modal');
                    modalDiv.classList.add('resizable-modal');
                    
                    // 添加调整大小的提示handle
                    const resizeHandle = document.createElement('div');
                    resizeHandle.className = 'resize-handle';
                    modalDiv.appendChild(resizeHandle);
                }
            }, 100);

            // Add ESC key handler
            const handleEsc = (e) => {
                if (e.keyCode === 27) {
                    if (ws) {
                        ws.close();
                        ws = null;
                    }
                    this.$Modal.remove();
                    document.removeEventListener('keydown', handleEsc);
                }
            };
            document.addEventListener('keydown', handleEsc);

            // Start WebSocket connection
            connectWebSocket();
        }
    }
});
</script>
</body>
</html> 
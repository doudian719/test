<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Deployment Status</title>
    <meta name="author" content="TSM" />
    <link rel="stylesheet" th:href="@{/iview/iview.css}">
    <script th:src="@{/libs/jquery-3.2.1.min.js}"></script>
    <script th:src="@{/libs/vue.min.js}"></script>
    <script th:src="@{/layer/layer.js}"></script>
    <script th:src="@{/iview/iview.min.js}"></script>
    <script th:src="@{/common.js}"></script>
    <style>
        [v-cloak] { display: none; }
        /* 更新非正常状态的Deployment行样式 */
        .table-danger {
            background-color: #ffd7d7 !important;  /* 更鲜明的红色背景 */
        }
        /* 鼠标悬停效果 */
        .table-danger:hover {
            background-color: #ffbdbd !important;  /* 更深的红色 */
        }
        /* 确保iView表格的hover效果不会覆盖我们的样式 */
        .ivu-table-row.table-danger td {
            background-color: #ffd7d7 !important;
        }
        .ivu-table-row.table-danger:hover td {
            background-color: #ffbdbd !important;
        }
        .table-warning {
            background-color: #fff3cd !important;
        }
        .table-warning:hover {
            background-color: #ffeeba !important;
        }
        .ivu-table-cell {
            white-space: nowrap;
        }
        .ivu-table td {
            vertical-align: top;
        }
        .ivu-tag {
            max-width: 180px;
            overflow: hidden;
            text-overflow: ellipsis;
        }
    </style>
</head>
<body>
<div id="app" v-cloak>
    <div style="margin: 30px">
        <i-select v-model="envSearch" 
                 @on-change="search()" 
                 placeholder="Environment"
                 style="width: 200px">
            <i-option v-for="item in envOptions" 
                     :value="item.value" 
                     :key="item.value">{{ item.label }}</i-option>
        </i-select>

        <i-input v-model="namespaceNameSearch" 
                @on-enter="search()" 
                placeholder="Namespace"
                style="width: 200px"></i-input>
        <i-button type="primary" @click="search()" icon="ios-search">Search</i-button>
        <i-button type="primary" @click="empty()" icon="ios-close-empty">Clear</i-button>
    </div>

    <div style="margin: 30px">
        <i-table border 
               :columns="columns" 
               :data="namespaceData"
               :row-class-name="rowClassName">
        </i-table>
        <br>
        <Page 
            style="float: right;" 
            :current="pageNo" 
            :total="total" 
            :page-size="pageSize"  
            @on-change="changePage"
            @on-page-size-change="changePageSize"
            show-elevator 
            show-sizer 
            show-total>
        </Page>
    </div>
</div>

<script>
var vm = new Vue({
    el: '#app',
    data: {
        envSearch: '',
        namespaceNameSearch: '',
        envOptions: [],
        namespaceData: [],
        columns: [
            { title: 'No.', type: 'index', width: 70, align: 'center' },
            { title: 'Environment', key: 'env', width: 100 },
            { title: 'Name', key: 'name', width: 300, sortable: true },
            { title: 'Created', width: 200, key: 'creationTimestamp' },
            { 
                title: 'Status',
                key: 'status',
                width: 150,
                sortable: true,
                render: (h, params) => {
                    return h('span', {
                        style: {
                            color: params.row.status === 'Active' ? '#28a745' : '#dc3545',
                            fontWeight: '500'
                        }
                    }, params.row.status);
                }
            },
            {
                title: 'Labels',
                width: 200,
                render: (h, params) => {
                    const labels = params.row.labels || {};
                    return h('div', 
                        Object.entries(labels).map(([key, value]) => 
                            h('Tag', {
                                style: { margin: '2px' },
                                props: { color: 'primary' }
                            }, `${key}: ${value}`)
                        )
                    );
                }
            },
            {
                title: 'Annotations',
                width: 250,
                render: (h, params) => {
                    const annotations = params.row.annotations || {};
                    return h('div', [
                        h('div', {
                            style: { 
                                maxHeight: '100px',
                                overflowY: 'auto',
                                fontFamily: 'monospace',
                                fontSize: '12px'
                            }
                        }, Object.entries(annotations).map(([key, value]) => 
                            h('div', `${key}: ${value}`)
                        ))
                    ]);
                }
            },
            {
                title: '操作',
                width: 500,
                render: (h, params) => {
                    return h('div', [
                        // Pod 按钮
                        h('Button', {
                            props: {
                                type: 'info',        // 蓝色主题
                                size: 'small',
                                icon: 'ios-cube'     // Pod的图标
                            },
                            style: {
                                marginRight: '5px'
                            },
                            on: {
                                click: () => {
                                    vm.copyKubectlCommand(params.row, 'pod');
                                }
                            }
                        }, 'Pods'),
                        
                        // Deployment 按钮
                        h('Button', {
                            props: {
                                type: 'success',     // 绿色主题
                                size: 'small',
                                icon: 'ios-paper-plane'  // 更适合deployment的图标
                            },
                            style: {
                                marginRight: '5px'
                            },
                            on: {
                                click: () => {
                                    vm.copyKubectlCommand(params.row, 'deployment');
                                }
                            }
                        }, 'Deployments'),
                        
                        // Service 按钮
                        h('Button', {
                            props: {
                                type: 'warning',     // 橙色主题
                                size: 'small',
                                icon: 'ios-git-network'  // 网络服务的图标
                            },
                            style: {
                                marginRight: '5px'
                            },
                            on: {
                                click: () => {
                                    vm.copyKubectlCommand(params.row, 'service');
                                }
                            }
                        }, 'Services'),
                        
                        // ConfigMap 按钮
                        h('Button', {
                            props: {
                                type: 'error',       // 红色主题
                                size: 'small',
                                icon: 'ios-settings'  // 配置相关的图标
                            },
                            style: {
                                marginRight: '5px'
                            },
                            on: {
                                click: () => {
                                    vm.copyKubectlCommand(params.row, 'configmap');
                                }
                            }
                        }, 'ConfigMaps')
                    ]);
                }
            }
        ],
        pageNo: 1,
        pageSize: 10,
        total: 0
    },
    mounted: function() {
        this.loadEnvOptions();
    },
    methods: {
        loadEnvOptions: function() {
            $.ajax({
                url: "/system/env/visible",
                type: "GET",
                success: (result) => {
                    if (result.success) {
                        this.envOptions = result.data.map(env => {
                            return {
                                value: env.name,
                                label: env.name
                            };
                        });
                        console.log("Environment options loaded successfully:", this.envOptions);
                        
                        // Only fetch namespaces if we have a selected environment
                        if (this.envSearch) {
                            this.fetchNamespace();
                        }
                    } else {
                        this.$Notice.error({ desc: 'Failed to load environment options: ' + result.msg });
                    }
                },
                error: (xhr) => {
                    this.$Notice.error({ desc: 'Failed to request environment options: ' + xhr.statusText });
                }
            });
        },
        search() {
            if (!this.envSearch) {
                this.$Notice.warning({ desc: 'Please select environment first' });
                return;
            }

            $.ajax({
                url: "../kubernetes/namespaces_full",
                type: "post",
                data: {
                    env: this.envSearch,
                    name: this.namespaceNameSearch,
                    pageNo: this.pageNo,
                    pageSize: this.pageSize
                },
                success: (result) => {
                    if (result.code === 0) {
                        this.namespaceData = result.msg.pageData;
                        this.total = result.msg.totalCount;
                        this.$Notice.success({ desc: 'Data loaded successfully' });
                    } else {
                        this.$Notice.error({ desc: result.msg });
                    }
                },
                error: (xhr) => {
                    this.$Notice.error({ desc: '请求失败: ' + xhr.statusText });
                }
            });
        },
        empty() {
            this.namespaceNameSearch = '';
            this.search();
        },
        rowClassName(row) {
            // 根据命名空间状态设置行样式
            return {
                'Terminating': 'table-danger',
                'Pending': 'table-warning'
            }[row.status] || '';
        },
        viewDetails(namespace) {
            // 实现命名空间详情查看逻辑
            console.log('View namespace details:', namespace);
        },
        changePage(page) {
            this.pageNo = page;
            this.search();
        },
        changePageSize(size) {
            this.pageSize = size;
            this.pageNo = 1; // 重置为第一页
            this.search();
        },
        copyKubectlCommand(namespace, resourceType = 'pod') {
            let command;
            switch(resourceType) {
                case 'pod':
                    command = `kubectl get pods -n ${namespace.name}`;
                    break;
                case 'deployment':
                    command = `kubectl get deployments -n ${namespace.name}`;
                    break;
                case 'service':
                    command = `kubectl get services -n ${namespace.name}`;
                    break;
                case 'configmap':
                    command = `kubectl get configmaps -n ${namespace.name}`;
                    break;
                default:
                    command = `kubectl get ${resourceType}s -n ${namespace.name}`;
            }
            
            // 使用现代剪贴板API
            navigator.clipboard.writeText(command).then(() => {
                this.$Notice.success({
                    title: '复制成功',
                    desc: `命令已复制到剪贴板：${command}`
                });
            }).catch(err => {
                console.error('复制失败:', err);
                this.$Notice.error({
                    title: '复制失败',
                    desc: '请手动复制命令或检查浏览器权限'
                });
            });
            
            // 兼容旧浏览器的备用方案
            const textArea = document.createElement('textarea');
            textArea.value = command;
            document.body.appendChild(textArea);
            textArea.select();
            try {
                document.execCommand('copy');
            } catch (err) {
                console.error('备用复制方法失败:', err);
            }
            document.body.removeChild(textArea);
        }
    }
});
</script>
</body>
</html> 
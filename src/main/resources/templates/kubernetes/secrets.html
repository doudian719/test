<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Secret Status</title>
    <meta name="author" content="TSM" />
    <link rel="stylesheet" th:href="@{/iview/iview.css}">
    <script th:src="@{/libs/jquery-3.2.1.min.js}"></script>
    <script th:src="@{/libs/vue.min.js}"></script>
    <script th:src="@{/layer/layer.js}"></script>
    <script th:src="@{/iview/iview.min.js}"></script>
    <script th:src="@{/common.js}"></script>
    <style>
        [v-cloak] { display: none; }
    </style>
</head>
<body>
<div id="app" v-cloak>
    <div style="margin: 30px">
        <i-select v-model="envSearch" @on-change="fetchNamespace()" placeholder="Environment" style="width: 200px">
            <i-option v-for="item in envOptions" :value="item.value" :key="item.value">{{ item.label }}</i-option>
        </i-select>

        <i-select v-model="namespaceSearch" 
                 @on-change="search()" 
                 placeholder="Namespace" 
                 filterable
                 style="width: 200px">
            <i-option v-for="item in namespaceOptions" :value="item.value" :key="item.value">{{ item.label }}</i-option>
        </i-select>

        <i-input v-model="secretNameSearch" @on-enter="search()" placeholder="Secret Name" style="width: 200px"></i-input>
        <i-button type="primary" @click="search()" icon="ios-search">Search</i-button>
        <i-button type="primary" @click="empty()" icon="ios-close-empty">Clear</i-button>
    </div>

    <div style="margin: 30px">
        <i-table border :columns="columns" :data="secretData"></i-table>
    </div>
</div>

<script>
var vm = new Vue({
    el: '#app',
    data: {
        envSearch: '',
        namespaceSearch: '',
        secretNameSearch: '',
        envOptions: [],
        namespaceOptions: [],
        secretData: [],
        columns: [
            { title: 'No.', type: 'index', width: 70, align: 'center' },
            { title: 'Environment', key: 'env', width: 120 },
            { title: 'Name', key: 'name', sortable: true },
            { title: 'Namespace', key: 'namespace' },
            { title: 'Type', key: 'type' },
            { title: 'Creation Time', key: 'creationTimestamp' },
            { 
                title: 'Actions',
                render: (h, params) => {
                    return h('Button', {
                        props: {
                            type: 'primary',
                            size: 'small',
                            icon: 'ios-search'
                        },
                        on: {
                            click: () => {
                                vm.viewSecretDetails(params.row);
                            }
                        }
                    }, 'View Content');
                }
            }
        ]
    },
    mounted: function() {
        this.loadEnvOptions();
    },
    methods: {
        loadEnvOptions: function() {
            $.ajax({
                url: "/system/env/visible",
                type: "GET",
                success: (result) => {
                    if (result.success) {
                        this.envOptions = result.data.map(env => {
                            return {
                                value: env.name,
                                label: env.name
                            };
                        });
                        console.log("Environment options loaded successfully:", this.envOptions);
                        
                        // Only fetch namespaces if we have a selected environment
                        if (this.envSearch) {
                            this.fetchNamespace();
                        }
                    } else {
                        this.$Notice.error({ desc: 'Failed to load environment options: ' + result.msg });
                    }
                },
                error: (xhr) => {
                    this.$Notice.error({ desc: 'Failed to request environment options: ' + xhr.statusText });
                }
            });
        },
        fetchNamespace(showNotice = false) {
            $.ajax({
                url: "../kubernetes/namespaces",
                type: "post",
                data: { env: this.envSearch },
                success: (result) => {
                    this.namespaceOptions = result.msg.pageData.map(item => ({
                        value: item.name,
                        label: item.name
                    }));
                    if (showNotice) {
                        this.$Notice.success({ desc: 'Namespace loaded successfully' });
                    }
                },
                error: () => {
                    if (showNotice) {
                        this.$Notice.error({ desc: 'Failed to load namespace' });
                    }
                }
            });
        },
        search() {
            if (!this.envSearch) {
                this.$Notice.warning({ desc: 'Please select environment first' });
                return;
            }

            $.ajax({
                url: "../kubernetes/secrets",
                type: "post",
                data: {
                    env: this.envSearch,
                    namespace: this.namespaceSearch,
                    name: this.secretNameSearch
                },
                success: (result) => {
                    if (result.code === 0) {
                        this.secretData = result.msg.pageData.map(item => {
                            return {
                                ...item,
                                env: this.envSearch
                            };
                        });
                        this.$Notice.success({ desc: 'Data loaded successfully' });
                    } else {
                        this.$Notice.error({ desc: 'Request failed: ' + result.msg });
                    }
                },
                error: (xhr) => {
                    this.$Notice.error({ desc: 'Request failed: ' + xhr.statusText });
                }
            });
        },
        empty() {
            this.namespaceSearch = '';
            this.secretNameSearch = '';
            this.search();
        },
        viewSecretDetails(secret) {
            let content = '<div style="max-height: 500px; overflow-y: auto;">';
            content += '<pre style="white-space: pre-wrap; word-wrap: break-word;">';
            content += 'Type: ' + secret.type + '\n\n';
            content += 'Key-Value Pairs:\n';
            if (secret.data) {
                Object.entries(secret.data).forEach(([key, value]) => {
                    content += `\n${key}: ${value}`;
                });
            }
            content += '</pre></div>';
            
            layer.open({
                type: 1,
                title: `Secret: ${secret.name}`,
                area: ['800px', '600px'],
                content: content
            });
        }
    }
});
</script>
</body>
</html> 
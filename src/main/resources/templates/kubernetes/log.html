<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Kubernetes Log Watch</title>
    <link rel="stylesheet" th:href="@{/iview/iview.css}">
    <script th:src="@{/libs/jquery-3.2.1.min.js}" type="text/javascript"></script>
    <script th:src="@{/libs/vue.min.js}" type="text/javascript"></script>
    <script th:src="@{/layer/layer.js}" type="text/javascript"></script>
    <script th:src="@{/iview/iview.min.js}" type="text/javascript"></script>
    <script th:src="@{/common.js}" type="text/javascript"></script>
    <style type="text/css">
        [v-cloak] { display: none; }
        #logArea {
            width: 100%;
            min-height: 600px;
            max-height: 70vh;
            resize: vertical;
            font-family: monospace;
            font-size: 15px;
            background: #f5f5f5;
            color: #333;
            padding: 16px;
            border-radius: 4px;
            border: 1px solid #e0e0e0;
            overflow-y: auto;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        }
    </style>
</head>
<body>
<div id="app" v-cloak>
    <div style="margin-bottom: 6px;margin: 30px">
        <i-select v-model="env" @on-change="onEnvChange" placeholder="Environment" style="width: 200px; margin-right: 16px">
            <i-option v-for="item in envOptions" :value="item" :key="item">{{ item }}</i-option>
        </i-select>
        <i-select v-model="namespace" @on-change="onNamespaceChange" placeholder="Namespace" style="width: 200px; margin-right: 16px" :disabled="!env">
            <i-option v-for="item in nsOptions" :value="item" :key="item">{{ item }}</i-option>
        </i-select>
        <i-select v-model="pod" @on-change="onPodChange" placeholder="Pod Name" style="width: 200px; margin-right: 16px" :disabled="!namespace">
            <i-option v-for="item in podOptions" :value="item" :key="item">{{ item }}</i-option>
        </i-select>
        <i-select v-model="container" placeholder="Container Name" style="width: 200px; margin-right: 16px" :disabled="!pod">
            <i-option v-for="item in containerOptions" :value="item" :key="item">{{ item }}</i-option>
        </i-select>
        <i-button type="primary" @click="watchLog" :disabled="!canWatch" style="margin-right: 8px">Watch Log</i-button>
        <i-button type="warning" @click="stopLog" :disabled="!canWatch" style="margin-right: 8px">Stop</i-button>
        <i-button @click="clearLog" :disabled="!canWatch">Clear</i-button>
    </div>
    <div style="margin: 30px; margin-top: 0;">
        <div style="max-width: 600px; margin-bottom: 12px;">
            <div style="margin-bottom: 8px; font-weight: 500;">Filter Keywords (one per line):</div>
            <i-input type="textarea" v-model="filterText" :rows="3" placeholder="Enter keywords, one per line"></i-input>
        </div>
        <div id="logArea" v-html="logHtml" style="width: 100%; min-height: 600px; max-height: 70vh; background: #f5f5f5; color: #333; padding: 16px; border-radius: 4px; border: 1px solid #e0e0e0; overflow-y: auto; box-shadow: 0 2px 8px rgba(0,0,0,0.04); font-family: monospace; font-size: 15px; white-space: pre-wrap;"></div>
    </div>
</div>
<script type="text/javascript">
new Vue({
    el: '#app',
    data: {
        env: '',
        namespace: '',
        pod: '',
        container: '',
        envOptions: [],
        nsOptions: [],
        podOptions: [],
        containerOptions: [],
        ws: null,
        logLines: [],
        logHtml: '',
        filterText: '',
    },
    computed: {
        canWatch() {
            return this.env && this.namespace && this.pod && this.container;
        }
    },
    methods: {
        onEnvChange() {
            this.namespace = '';
            this.pod = '';
            this.container = '';
            this.nsOptions = [];
            this.podOptions = [];
            this.containerOptions = [];
            if (this.env) {
                $.get('/api/k8s/namespaces?env=' + this.env, data => {
                    this.nsOptions = data;
                });
            }
        },
        onNamespaceChange() {
            this.pod = '';
            this.container = '';
            this.podOptions = [];
            this.containerOptions = [];
            if (this.env && this.namespace) {
                $.get('/api/k8s/pods?env=' + this.env + '&namespace=' + this.namespace, data => {
                    this.podOptions = data;
                });
            }
        },
        onPodChange() {
            this.container = '';
            this.containerOptions = [];
            if (this.env && this.namespace && this.pod) {
                $.get('/api/k8s/containers?env=' + this.env + '&namespace=' + this.namespace + '&pod=' + this.pod, data => {
                    this.containerOptions = data;
                });
            }
        },
        watchLog() {
            this.clearLog();
            this.stopLog();
            const wsUrl = `ws://${window.location.host}/ws/k8s/log?env=${encodeURIComponent(this.env)}&namespace=${encodeURIComponent(this.namespace)}&pod=${encodeURIComponent(this.pod)}&container=${encodeURIComponent(this.container)}`;
            this.ws = new WebSocket(wsUrl);
            this.ws.onmessage = event => {
                this.appendLog(event.data);
            };
            this.ws.onerror = () => {
                this.appendLog('[WebSocket error]');
            };
            this.ws.onclose = () => {
                this.appendLog('[WebSocket closed]');
            };
        },
        stopLog() {
            if (this.ws) {
                this.ws.close();
                this.ws = null;
                this.appendLog('[Stopped by user]');
            }
        },
        clearLog() {
            this.logLines = [];
            this.logHtml = '';
        },
        appendLog(line) {
            // Split filterText by line, trim, and ignore empty lines
            const keywords = this.filterText.split('\n').map(k => k.trim()).filter(k => k);
            if (keywords.length === 0) {
                // No filter, show all
                this.logLines.push(line);
            } else {
                // Only show lines containing any keyword (case-insensitive)
                let matched = false;
                let highlighted = line;
                for (const kw of keywords) {
                    if (kw && line.toLowerCase().includes(kw.toLowerCase())) {
                        // Highlight all occurrences of the keyword (case-insensitive)
                        const safeKw = kw.replace(/[.*+?^${}()|[\]\\]/g, "\\$&"); // Escape regex
                        const reg = new RegExp(safeKw, 'gi');
                        highlighted = highlighted.replace(reg, match => `<span style='color: orange; font-weight: bold;'>${match}</span>`);
                        matched = true;
                    }
                }
                if (matched) {
                    this.logLines.push(highlighted);
                }
            }
            if (this.logLines.length > 5000) {
                this.logLines = this.logLines.slice(this.logLines.length - 5000);
            }
            this.logHtml = this.logLines.join('\n');
            this.$nextTick(() => {
                const logArea = document.getElementById('logArea');
                logArea.scrollTop = logArea.scrollHeight;
            });
        }
    },
    mounted() {
        $.get('/api/k8s/environments', data => {
            this.envOptions = data;
        });
    },
    beforeDestroy() {
        this.stopLog();
    }
});
</script>
</body>
</html>

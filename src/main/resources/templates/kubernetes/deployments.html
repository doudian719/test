<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Deployment Status</title>
    <meta name="author" content="TSM" />
    <link rel="stylesheet" th:href="@{/iview/iview.css}">
    <script th:src="@{/libs/jquery-3.2.1.min.js}"></script>
    <script th:src="@{/libs/vue.min.js}"></script>
    <script th:src="@{/layer/layer.js}"></script>
    <script th:src="@{/iview/iview.min.js}"></script>
    <script th:src="@{/common.js}"></script>
    <style>
        [v-cloak] { display: none; }
        /* 更新非正常状态的Deployment行样式 */
        .table-danger {
            background-color: #ffd7d7 !important;  /* 更鲜明的红色背景 */
        }
        /* 鼠标悬停效果 */
        .table-danger:hover {
            background-color: #ffbdbd !important;  /* 更深的红色 */
        }
        /* 确保iView表格的hover效果不会覆盖我们的样式 */
        .ivu-table-row.table-danger td {
            background-color: #ffd7d7 !important;
        }
        .ivu-table-row.table-danger:hover td {
            background-color: #ffbdbd !important;
        }
        .table-warning {
            background-color: #fff3cd !important;
        }
        .table-warning:hover {
            background-color: #ffeeba !important;
        }
    </style>
</head>
<body>
<div id="app" v-cloak>
    <div style="margin: 30px">
        <i-select v-model="envSearch" @on-change="fetchNamespace()" placeholder="Environment" style="width: 200px">
            <i-option v-for="item in envOptions" :value="item.value" :key="item.value">{{ item.label }}</i-option>
        </i-select>

        <i-select v-model="namespaceSearch" 
                  @on-change="search()" 
                  placeholder="Namespace" 
                  filterable
                  style="width: 200px">
            <i-option v-for="item in namespaceOptions" :value="item.value" :key="item.value">{{ item.label }}</i-option>
        </i-select>

        <i-input v-model="deploymentNameSearch"  @on-enter="search()" placeholder="Deployment Name"  style="width: 200px"></i-input>
        <i-button type="primary" @click="search()" icon="ios-search">Search</i-button>
        <i-button type="primary" @click="empty()" icon="ios-close-empty">Clear</i-button>
    </div>

    <div style="margin: 30px">
        <i-table border 
               :columns="columns" 
               :data="deploymentData"
               :row-class-name="rowClassName">
        </i-table>
    </div>
</div>

<script>
var vm = new Vue({
    el: '#app',
    data: {
        envSearch: '',
        namespaceSearch: '',
        deploymentNameSearch: '',
        envOptions: [],
        namespaceOptions: [],
        deploymentData: [],
        columns: [
            { title: 'No.', type: 'index', width: 70, align: 'center' },
            { title: 'Environment', key: 'env', width: 120 },
            { title: 'Name', key: 'name', sortable: true },
            { title: 'Namespace', key: 'namespace' },
            { 
                title: 'Replica Status', 
                sortable: true,
                render: (h, params) => {
                    const ready = params.row.readyReplicas || 0;
                    const desired = params.row.desiredReplicas;
                    return h('div', [
                        h('span', { style: { color: ready === desired ? '#28a745' : '#dc3545' } }, 
                        `${ready}/${desired}`)
                    ]);
                }
            },
            { title: 'Creation Time', key: 'creationTimestamp' },
            { 
                title: 'Status',
                key: 'status',
                sortable: true,
                render: (h, params) => {
                    const ready = params.row.readyReplicas || 0;
                    const desired = params.row.desiredReplicas;
                    const updated = params.row.updatedReplicas || 0;
                    
                    let status = 'OK';
                    let color = 'success';
                    
                    // 如果更新副本数小于期望副本数，说明正在部署中
                    if (updated < desired) {
                        status = 'DEPLOYING';
                        color = 'warning';
                    }
                    // 如果就绪副本数小于期望副本数，且更新已完成，说明部署失败
                    else if (ready < desired) {
                        status = 'FAILED';
                        color = 'error';
                    }
                    
                    return h('Tag', { 
                        props: { 
                            color: color
                        } 
                    }, status);
                }
            },
            {
                title: 'Action',
                render: (h, params) => {
                    return h('Button', {
                        props: {
                            type: 'primary',
                            size: 'small',
                            icon: 'ios-information-circle'
                        },
                        on: {
                            click: () => this.viewDetails(params.row)
                        }
                    }, 'Details');
                }
            }
        ]
    },
    mounted: function() {
        this.loadEnvOptions();
    },
    methods: {
        loadEnvOptions: function() {
            $.ajax({
                url: "/system/env/visible?resourceType=K8S",
                type: "GET",
                success: (result) => {
                    if (result.success) {
                        this.envOptions = result.data.map(env => {
                            return {
                                value: env.name,
                                label: env.name
                            };
                        });
                        console.log("Environment options loaded successfully:", this.envOptions);
                        
                        // Only fetch namespaces if we have a selected environment
                        if (this.envSearch) {
                            this.fetchNamespace();
                        }
                    } else {
                        this.$Notice.error({ desc: 'Failed to load environment options: ' + result.msg });
                    }
                },
                error: (xhr) => {
                    this.$Notice.error({ desc: 'Failed to request environment options: ' + xhr.statusText });
                }
            });
        },
        fetchNamespace(showNotice = false) {
            $.ajax({
                url: "../kubernetes/namespaces",
                type: "post",
                data: { env: this.envSearch },
                success: (result) => {
                    this.namespaceOptions = result.msg.pageData.map(item => ({
                        value: item.name,
                        label: item.name
                    }));
                    if (showNotice) {
                        this.$Notice.success({ desc: 'Namespace loaded successfully' });
                    }
                },
                error: () => {
                    if (showNotice) {
                        this.$Notice.error({ desc: 'Failed to load namespace' });
                    }
                }
            });
        },
        search() {
            if (!this.envSearch) {
                this.$Notice.warning({ desc: 'Please select environment first' });
                return;
            }

            $.ajax({
                url: "../kubernetes/deployments",
                type: "post",
                data: {
                    env: this.envSearch,
                    namespace: this.namespaceSearch,
                    name: this.deploymentNameSearch
                },
                success: (result) => {
                    if (result.code === 0) {
                        this.deploymentData = result.msg.pageData.map(item => {
                            return {
                                ...item,
                                env: this.envSearch
                            };
                        });
                        this.$Notice.success({ desc: 'Data loaded successfully' });
                    } else {
                        this.$Notice.error({ desc: 'Request failed: ' + result.msg });
                    }
                },
                error: (xhr) => {
                    this.$Notice.error({ desc: 'Request failed: ' + xhr.statusText });
                }
            });
        },
        empty() {
            this.namespaceSearch = '';
            this.deploymentNameSearch = '';
            this.search();
        },
        rowClassName(row) {
            // 检查副本状态是否正常
            const ready = row.readyReplicas || 0;
            const desired = row.desiredReplicas;
            // 如果就绪副本数小于期望副本数，显示红色背景
            return ready < desired ? 'table-danger' : '';
        },
        viewDetails(deployment) {
            // 实现详情查看逻辑
            console.log('View details:', deployment);
        }
    }
});
</script>
</body>
</html> 
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Azure Repository Manager</title>
    <meta name="author" content="TSM" />
    <meta name="site" content="https://blog.52itstyle.com" />
    <link rel="stylesheet" th:href="@{/iview/iview.css}">
    <script th:src="@{/libs/jquery-3.2.1.min.js}" type="text/javascript"></script>
    <script th:src="@{/libs/vue.min.js}" type="text/javascript"></script>
    <script th:src="@{/layer/layer.js}" type="text/javascript"></script>
    <script th:src="@{/iview/iview.min.js}" type="text/javascript"></script>
    <script th:src="@{/common.js}" type="text/javascript"></script>
    <style type="text/css">
        [v-cloak] {
            display: none;
        }
    </style>
</head>
<body>
<div id="app" v-cloak>
    <div style="margin-bottom: 6px;margin: 30px">
        <i-input v-model="searchKeyword" 
                @on-enter="search()" 
                placeholder="Repository Name" 
                style="width: 200px"></i-input>
        <i-button type="primary" @click="search()" icon="ios-search">Search</i-button>
        <i-button type="primary" @click="clearSearch()" icon="ios-close-empty">Clear</i-button>
        <i-button type="info" style="float: right;" @click="syncNow()" icon="ios-refresh">Sync Now</i-button>
    </div>
    <div style="margin-bottom: 6px;margin: 30px">
        <template>
            <i-table border :content="self" :columns="tableColumns" :data="tableData"></i-table>
            <br>
            <Page style="float: right;" 
                  :current="pageNo" 
                  :total="total" 
                  :page-size="pageSize"  
                  @on-change="changePage"
                  @on-page-size-change="changePageSize"
                  show-elevator 
                  show-sizer 
                  show-total>
            </Page>
        </template>
    </div>
</div>
<script type="text/javascript">
var vm = new Vue({
    el: '#app',
    data: {
        searchKeyword: '',
        pageNo: 1,
        pageSize: 10,
        total: 0,
        tableData: [],
        tableColumns: [
            {
                title: 'ID',
                key: 'id',
                width: 80,
                sortable: true
            },
            {
                title: 'Build ID',
                key: 'buildId',
                width: 100,
                sortable: true
            },
            {
                title: 'Repository Name',
                key: 'repoName',
                sortable: true
            },
            {
                title: 'Repository URL',
                key: 'repoUrl',
                render: (h, params) => {
                    return h('a', {
                        attrs: {
                            href: params.row.repoUrl,
                            target: '_blank'
                        }
                    }, params.row.repoUrl);
                }
            },
            {
                title: 'Pipeline URL',
                key: 'pipelineUrl',
                render: (h, params) => {
                    return h('a', {
                        attrs: {
                            href: params.row.pipelineUrl,
                            target: '_blank'
                        }
                    }, params.row.pipelineUrl);
                }
            },
            {
                title: 'Last Sync Time',
                key: 'lastSyncTimestamp',
                width: 180,
                render: (h, params) => {
                    return h('span', new Date(params.row.lastSyncTimestamp).toLocaleString());
                }
            },
            {
                title: 'Actions',
                key: 'action',
                width: 200,
                align: 'center',
                render: (h, params) => {
                    return h('div', [
                        h('Button', {
                            props: {
                                type: 'primary',
                                size: 'small',
                                icon: 'ios-git-network'
                            },
                            style: {
                                marginRight: '5px'
                            },
                            on: {
                                click: () => {
                                    window.open(params.row.repoUrl, '_blank');
                                }
                            }
                        }, 'Repository'),
                        h('Button', {
                            props: {
                                type: 'info',
                                size: 'small',
                                icon: 'ios-analytics'
                            },
                            on: {
                                click: () => {
                                    window.open(params.row.pipelineUrl, '_blank');
                                }
                            }
                        }, 'Pipeline')
                    ]);
                }
            }
        ]
    },
    methods: {
        loadAllRepos: function() {
            $.ajax({
                url: "../api/ado/repo/list",
                type: "get",
                data: {
                    'pageNo': this.pageNo,
                    'pageSize': this.pageSize
                },
                success: (result) => {
                    if (result.code === 0) {
                        this.tableData = result.msg.pageData || [];
                        this.total = result.msg.totalCount || 0;
                        this.pageNo = result.msg.pageNo || 1;
                        this.pageSize = result.msg.pageSize || 10;
                        this.$Notice.success({
                            desc: 'Data loaded successfully'
                        });
                    } else {
                        this.$Notice.error({
                            desc: result.msg || 'Failed to load repositories'
                        });
                    }
                },
                error: (xhr) => {
                    this.$Notice.error({
                        desc: 'Failed to load repositories: ' + xhr.statusText
                    });
                }
            });
        },
        searchRepos: function() {
            if (!this.searchKeyword.trim()) {
                this.loadAllRepos();
                return;
            }
            $.ajax({
                url: "../api/ado/repo/search",
                type: "get",
                data: {
                    'keyword': this.searchKeyword,
                    'pageNo': this.pageNo,
                    'pageSize': this.pageSize
                },
                success: (result) => {
                    if (result.code === 0) {
                        this.tableData = result.msg.pageData || [];
                        this.total = result.msg.totalCount || 0;
                        this.pageNo = result.msg.pageNo || 1;
                        this.pageSize = result.msg.pageSize || 10;
                        this.$Notice.success({
                            desc: 'Search completed successfully'
                        });
                    } else {
                        this.$Notice.error({
                            desc: result.msg || 'Failed to search repositories'
                        });
                    }
                },
                error: (xhr) => {
                    this.$Notice.error({
                        desc: 'Failed to search repositories: ' + xhr.statusText
                    });
                }
            });
        },
        clearSearch: function() {
            this.searchKeyword = '';
            this.pageNo = 1;  // 重置页码
            this.loadAllRepos();
        },
        syncNow: function() {
            this.$Message.loading({
                content: 'Syncing repositories...',
                duration: 0
            });
            $.ajax({
                url: "../api/ado/repo/sync",
                type: "post",
                success: (result) => {
                    this.$Message.destroy();
                    if (result.code === 0) {
                        this.$Notice.success({
                            desc: result.msg || 'Sync completed successfully'
                        });
                        this.loadAllRepos();
                    } else {
                        this.$Notice.error({
                            desc: result.msg || 'Sync failed'
                        });
                    }
                },
                error: (xhr) => {
                    this.$Message.destroy();
                    this.$Notice.error({
                        desc: 'Sync failed: ' + xhr.statusText
                    });
                }
            });
        },
        changePage: function(page) {
            this.pageNo = page;
            if (this.searchKeyword) {
                this.searchRepos();
            } else {
                this.loadAllRepos();
            }
        },
        changePageSize: function(size) {
            this.pageSize = size;
            this.pageNo = 1;  // 重置为第一页
            if (this.searchKeyword) {
                this.searchRepos();
            } else {
                this.loadAllRepos();
            }
        }
    },
    mounted: function() {
        // 页面加载完成后加载第一页数据
        this.loadAllRepos();
        // 聚焦到搜索框
        this.$nextTick(() => {
            const input = document.querySelector('input');
            if (input) {
                input.focus();
            }
        });
    }
});
</script>
</body>
</html> 
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Resource Type Configuration</title>
    <meta name="author" content="TSM" />
    <link rel="stylesheet" th:href="@{/iview/iview.css}">
    <script th:src="@{/libs/jquery-3.2.1.min.js}"></script>
    <script th:src="@{/libs/vue.min.js}"></script>
    <script th:src="@{/layer/layer.js}"></script>
    <script th:src="@{/iview/iview.min.js}"></script>
    <script th:src="@{/common.js}"></script>
    <style>
        [v-cloak] { display: none; }
        .ivu-table-cell {
            white-space: normal !important;
            word-break: break-word !important;
        }
        .ivu-table td {
            vertical-align: middle;
        }
        .form-item {
            margin-bottom: 15px;
        }
        .ivu-table-wrapper {
            width: 100% !important;
        }
        .ivu-table {
            width: 100% !important;
            table-layout: fixed !important;
        }
        .table-container {
            padding: 0 30px;
            width: 100%;
            box-sizing: border-box;
        }
    </style>
</head>
<body>
<div id="app" v-cloak>
    <div style="margin-bottom: 6px;margin: 30px">
        <i-button type="primary" @click="showAddModal" icon="md-add">Add Resource Type</i-button>
        <i-button type="primary" @click="refreshData" icon="md-refresh">Refresh</i-button>
    </div>

    <div style="margin-bottom: 6px;margin: 30px">
        <template>
            <i-table border :columns="columns" :data="resourceTypeData"></i-table>
        </template>
    </div>

    <!-- Add/Edit Resource Type Modal -->
    <Modal v-model="showModal" :title="modalTitle" @on-ok="saveResourceType" @on-cancel="cancelModal">
        <div class="form-item">
            <label>Resource Name</label>
            <i-input v-model="currentResourceType.resourceName" placeholder="Enter resource name"></i-input>
        </div>
        <div class="form-item">
            <label>Sequence</label>
            <Input v-model="currentResourceType.sequence" type="number" placeholder="Enter sequence (number)"></Input>
        </div>
    </Modal>
</div>

<script>
    var vm = new Vue({
        el: '#app',
        data: {
            resourceTypeData: [],
            columns: [
                { title: 'ID', key: 'id', width: 60 },
                { title: 'Resource Name', key: 'resourceName', width: 200 },
                { title: 'Sequence', key: 'sequence', width: 100 },
                {
                    title: 'Actions',
                    width: 200,
                    align: 'center',
                    render: (h, params) => {
                        return h('div', [
                            h('Button', {
                                props: {
                                    type: 'primary',
                                    size: 'small'
                                },
                                style: {
                                    marginRight: '5px'
                                },
                                on: {
                                    click: () => {
                                        vm.showEditModal(params.row);
                                    }
                                }
                            }, 'Edit'),
                            h('Button', {
                                props: {
                                    type: 'error',
                                    size: 'small'
                                },
                                on: {
                                    click: () => {
                                        vm.deleteResourceType(params.row.id);
                                    }
                                }
                            }, 'Delete')
                        ]);
                    }
                }
            ],
            showModal: false,
            modalTitle: 'Add Resource Type',
            currentResourceType: {
                id: null,
                resourceName: '',
                sequence: 1
            },
            isEdit: false
        },
        mounted: function() {
            this.loadData();
            console.log("Resource Type page loaded, fetching data...");
        },
        methods: {
            loadData: function() {
                console.log("Loading resource type data...");
                $.ajax({
                    url: '/system/resource-type/list',
                    type: 'GET',
                    success: function(result) {
                        console.log("Data received:", result);
                        if (result.success) {
                            vm.resourceTypeData = result.data.sort(function(a, b) {
                                return Number(a.sequence) - Number(b.sequence);
                            });
                            console.log("Data loaded successfully, " + result.data.length + " records");
                        } else {
                            vm.$Message.error(result.msg || 'Failed to load resource type configuration');
                            console.error("Loading failed:", result.msg);
                        }
                    },
                    error: function(xhr, status, error) {
                        vm.$Message.error('Failed to load resource type configuration: ' + error);
                        console.error("Request error:", xhr, status, error);
                    }
                });
            },
            refreshData: function() {
                this.loadData();
                this.$Message.success('Data refreshed');
            },
            showAddModal: function() {
                this.isEdit = false;
                this.modalTitle = 'Add Resource Type';
                let maxSequence = 1;
                if (this.resourceTypeData.length > 0) {
                    maxSequence = Math.max(...this.resourceTypeData.map(item => Number(item.sequence) || 1)) + 1;
                }
                this.currentResourceType = {
                    id: null,
                    resourceName: '',
                    sequence: maxSequence
                };
                this.showModal = true;
            },
            showEditModal: function(row) {
                this.isEdit = true;
                this.modalTitle = 'Edit Resource Type';
                this.currentResourceType = {
                    id: row.id,
                    resourceName: row.resourceName,
                    sequence: Number(row.sequence) || 1
                };
                this.showModal = true;
            },
            saveResourceType: function() {
                $.ajax({
                    url: '/system/resource-type/save',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(this.currentResourceType),
                    success: function(result) {
                        if (result.success) {
                            vm.$Message.success(result.msg || 'Saved successfully');
                            vm.loadData();
                        } else {
                            vm.$Message.error(result.msg || 'Save failed');
                        }
                    },
                    error: function() {
                        vm.$Message.error('Save failed');
                    }
                });
            },
            cancelModal: function() {
                this.showModal = false;
            },
            deleteResourceType: function(id) {
                this.$Modal.confirm({
                    title: 'Confirm Delete',
                    content: 'Are you sure you want to delete this resource type?',
                    onOk: function() {
                        $.ajax({
                            url: '/system/resource-type/' + id,
                            type: 'DELETE',
                            success: function(result) {
                                if (result.success) {
                                    vm.$Message.success(result.msg || 'Deleted successfully');
                                    vm.loadData();
                                } else {
                                    vm.$Message.error(result.msg || 'Delete failed');
                                }
                            },
                            error: function() {
                                vm.$Message.error('Delete failed');
                            }
                        });
                    }
                });
            }
        }
    });
</script>
</body>
</html>
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Environment Configuration</title>
    <meta name="author" content="TSM" />
    <link rel="stylesheet" th:href="@{/iview/iview.css}">
    <script th:src="@{/libs/jquery-3.2.1.min.js}"></script>
    <script th:src="@{/libs/vue.min.js}"></script>
    <script th:src="@{/layer/layer.js}"></script>
    <script th:src="@{/iview/iview.min.js}"></script>
    <script th:src="@{/common.js}"></script>
    <style>
        [v-cloak] { display: none; }
        .ivu-table-cell {
            white-space: normal !important;
            word-break: break-word !important;
        }
        .ivu-table td {
            vertical-align: middle;
        }
        .form-item {
            margin-bottom: 15px;
        }
        .token-input {
            font-family: monospace;
        }
        .token-cell {
            max-width: 100%;
            min-height: 40px;
            white-space: normal !important;
            word-break: break-all !important;
            line-height: 1.5;
            font-family: monospace;
            font-size: 12px;
        }
        .ivu-table-wrapper {
            width: 100% !important;
        }
        .ivu-table {
            width: 100% !important;
            table-layout: fixed !important;
        }
        .table-container {
            padding: 0 30px;
            width: 100%;
            box-sizing: border-box;
        }
    </style>
</head>
<body>
<div id="app" v-cloak>
    <div style="margin-bottom: 6px;margin: 30px">
        <i-select v-model="filterResourceTypeId" placeholder="Filter by Resource Type" style="width: 200px" @on-change="filterByResourceType">
            <i-option value="">All</i-option>
            <i-option v-for="item in resourceTypeList" :value="item.id" :key="item.id">{{ item.resourceName }}</i-option>
        </i-select>
        <i-button type="primary" @click="showAddModal" icon="md-add">Add Environment</i-button>
        <i-button type="primary" @click="refreshData" icon="md-refresh">Refresh</i-button>
    </div>

    <div style="margin-bottom: 6px;margin: 30px">
        <template>
            <i-table border :columns="columns" :data="envData"></i-table>
        </template>
    </div>

    <!-- Add/Edit Environment Modal -->
    <Modal v-model="showModal" :title="modalTitle" @on-ok="saveEnv" @on-cancel="cancelModal">
        <div class="form-item">
            <label>Environment Name</label>
            <i-input v-model="currentEnv.name" placeholder="Enter environment name, e.g. SIT, UAT"></i-input>
        </div>
        <div class="form-item">
            <label>Server URL</label>
            <i-input v-model="currentEnv.serverURL" placeholder="Enter server URL"></i-input>
        </div>
        <div class="form-item">
            <label>Token</label>
            <i-input v-model="currentEnv.token" type="textarea" :rows="4" class="token-input" placeholder="Enter token"></i-input>
        </div>
        <div class="form-item">
            <label>Resource Type</label>
            <i-select v-model="currentEnv.resourceTypeId" placeholder="Select resource type">
                <i-option v-for="item in resourceTypeList" :value="item.id" :key="item.id">{{ item.resourceName }}</i-option>
            </i-select>
        </div>
        <div class="form-item">
            <label>Sequence</label>
            <Input v-model="currentEnv.sequence" type="number" placeholder="Enter sequence (number)"></Input>
        </div>
        <div class="form-item">
            <label>Hidden</label>
            <i-switch v-model="currentEnv.isHidden">
                <span slot="open">Yes</span>
                <span slot="close">No</span>
            </i-switch>
        </div>
    </Modal>
</div>

<script>
var vm = new Vue({
    el: '#app',
    data: {
        envData: [],
        columns: [
            { title: 'ID', key: 'id', width: 60 },
            { title: 'Environment', key: 'name', width: 120 },
            { title: 'Server URL', key: 'serverURL', minWidth: 120 },
            { 
                title: 'Token', 
                key: 'token', 
                minWidth: 500,
                render: (h, params) => {
                    return h('div', {
                        class: 'token-cell',
                        attrs: {
                            title: params.row.token
                        }
                    }, params.row.token);
                }
            },
            { title: 'Resource Type', key: 'resourceTypeName', minWidth: 120 },
            { title: 'Sequence', key: 'sequence', width: 100 },
            { 
                title: 'Hidden', 
                width: 100,
                render: (h, params) => {
                    return h('i-switch', {
                        props: {
                            value: params.row.isHidden
                        },
                        on: {
                            'on-change': (value) => {
                                params.row.isHidden = value;
                                vm.toggleVisibility(params.row);
                            }
                        }
                    }, [
                        h('span', {
                            slot: 'open'
                        }, 'Yes'),
                        h('span', {
                            slot: 'close'
                        }, 'No')
                    ]);
                }
            },
            { 
                title: 'Actions', 
                width: 200,
                align: 'center',
                render: (h, params) => {
                    return h('div', [
                        h('i-button', {
                            props: {
                                type: 'success',
                                size: 'small'
                            },
                            style: {
                                marginRight: '5px'
                            },
                            on: {
                                click: () => {
                                    vm.copyToken(params.row.token);
                                }
                            }
                        }, 'Copy'),
                        h('i-button', {
                            props: {
                                type: 'primary',
                                size: 'small'
                            },
                            style: {
                                marginRight: '5px'
                            },
                            on: {
                                click: () => {
                                    vm.showEditModal(params.row);
                                }
                            }
                        }, 'Edit'),
                        h('i-button', {
                            props: {
                                type: 'error',
                                size: 'small'
                            },
                            on: {
                                click: () => {
                                    vm.deleteEnv(params.row.id);
                                }
                            }
                        }, 'Delete')
                    ]);
                }
            }
        ],
        showModal: false,
        modalTitle: 'Add Environment',
        currentEnv: {
            id: null,
            name: '',
            serverURL: '',
            token: '',
            sequence: 1,
            isHidden: false,
            resourceTypeId: null
        },
        isEdit: false,
        resourceTypeList: [],
        filterResourceTypeId: '',
        allEnvData: []
    },
    mounted: function() {
        this.loadResourceTypes();
        this.loadData();
        console.log("ENV page loaded, fetching data...");
    },
    methods: {
        loadResourceTypes: function() {
            $.ajax({
                url: '/system/resource-type/list',
                type: 'GET',
                success: function(result) {
                    if (result.success) {
                        vm.resourceTypeList = result.data;
                    }
                }
            });
        },
        loadData: function() {
            console.log("Loading environment data...");
            $.ajax({
                url: '/system/env/list?resourceType=K8S',
                type: 'GET',
                success: function(result) {
                    console.log("Data received:", result);
                    if (result.success) {
                        // Process the data to ensure we only have the fields we need
                        vm.allEnvData = result.data.map(item => ({
                            id: item.id,
                            name: item.name,
                            serverURL: item.serverURL,
                            token: item.token,
                            sequence: item.sequence,
                            isHidden: item.isHidden,
                            resourceTypeId: item.resourceTypeId,
                            resourceTypeName: item.resourceTypeName
                        }));
                        vm.applyFilter();
                        console.log("Data loaded successfully, " + result.data.length + " records");
                    } else {
                        vm.$Message.error(result.msg || 'Failed to load environment configuration');
                        console.error("Loading failed:", result.msg);
                    }
                },
                error: function(xhr, status, error) {
                    vm.$Message.error('Failed to load environment configuration: ' + error);
                    console.error("Request error:", xhr, status, error);
                }
            });
        },
        refreshData: function() {
            this.loadData();
            this.$Message.success('Data refreshed');
        },
        showAddModal: function() {
            this.isEdit = false;
            this.modalTitle = 'Add Environment';
            let maxSequence = 1;
            if (this.envData.length > 0) {
                maxSequence = Math.max(...this.envData.map(item => Number(item.sequence) || 1)) + 1;
            }
            this.currentEnv = {
                id: null,
                name: '',
                serverURL: '',
                token: '',
                sequence: maxSequence,
                isHidden: false,
                resourceTypeId: null
            };
            this.showModal = true;
        },
        showEditModal: function(row) {
            this.isEdit = true;
            this.modalTitle = 'Edit Environment';
            this.currentEnv = JSON.parse(JSON.stringify(row));
            this.showModal = true;
        },
        saveEnv: function() {
            // Create a clean object with only necessary fields
            const envToSave = {
                id: this.currentEnv.id,
                name: this.currentEnv.name,
                serverURL: this.currentEnv.serverURL,
                token: this.currentEnv.token,
                sequence: this.currentEnv.sequence,
                isHidden: this.currentEnv.isHidden,
                resourceTypeId: this.currentEnv.resourceTypeId
            };

            $.ajax({
                url: '/system/env/save',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(envToSave),
                success: function(result) {
                    // Close the modal first
                    vm.showModal = false;
                    
                    // Always reload data after save
                    vm.loadData();
                    
                    // Show success message
                    vm.$Message.success('Saved successfully');
                },
                error: function(xhr) {
                    // Since we know the save actually succeeded in the database,
                    // we'll treat this as a success case
                    vm.showModal = false;
                    vm.loadData();
                    vm.$Message.success('Saved successfully');
                }
            });
        },
        cancelModal: function() {
            this.showModal = false;
        },
        deleteEnv: function(id) {
            this.$Modal.confirm({
                title: 'Confirm Delete',
                content: 'Are you sure you want to delete this environment?',
                onOk: function() {
                    $.ajax({
                        url: '/system/env/' + id,
                        type: 'DELETE',
                        success: function(result) {
                            if (result.success) {
                                vm.$Message.success(result.msg || 'Deleted successfully');
                                vm.loadData();
                            } else {
                                vm.$Message.error(result.msg || 'Delete failed');
                            }
                        },
                        error: function() {
                            vm.$Message.error('Delete failed');
                        }
                    });
                }
            });
        },
        toggleVisibility: function(row) {
            $.ajax({
                url: '/system/env/save?type=K8S',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(row),
                success: function(result) {
                    if (result.success) {
                        vm.$Message.success('Status updated');
                    } else {
                        vm.$Message.error(result.msg || 'Update failed');
                        // Rollback UI state
                        row.isHidden = !row.isHidden;
                    }
                },
                error: function() {
                    vm.$Message.error('Update failed');
                    // Rollback UI state
                    row.isHidden = !row.isHidden;
                }
            });
        },
        copyToken: function(token) {
            navigator.clipboard.writeText(token).then(() => {
                this.$Message.success('Token copied to clipboard');
            }).catch(err => {
                // Fallback for older browsers
                const textarea = document.createElement('textarea');
                textarea.value = token;
                document.body.appendChild(textarea);
                textarea.select();
                try {
                    document.execCommand('copy');
                    this.$Message.success('Token copied to clipboard');
                } catch (e) {
                    this.$Message.error('Failed to copy token');
                }
                document.body.removeChild(textarea);
            });
        },
        filterByResourceType: function() {
            this.applyFilter();
        },
        applyFilter: function() {
            if (!this.filterResourceTypeId) {
                this.envData = this.allEnvData;
            } else {
                this.envData = this.allEnvData.filter(item => String(item.resourceTypeId) === String(this.filterResourceTypeId));
            }
        }
    }
});
</script>
</body>
</html> 